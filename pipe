pipeline {
    agent any

    environment {
        DEPLOY_HOST     = "192.168.1.60"
        DEPLOY_PATH     = "/home/deployuser/appnet"
        PROJECT_PATH    = "testnetDocker1"
        CONTAINER_NAME  = "net-app1"
        IMAGE_NAME      = "net-app1"
        SONAR_PROJECT   = "testnetDocker1"
        SONAR_TOKEN     = credentials('SonarToken')  // Token de SonarQube en Jenkins
    }

    stages {

        // Clonar el repositorio
        stage('Clonar repo') {
            steps {
                git branch: 'main', url: 'https://github.com/andrez299321/testJenkinsnet.git'
            }
        }

        // An√°lisis de c√≥digo est√°tico con SonarQube
        stage('An√°lisis SonarQube') {
            steps {
                script {
                    // Obtener la ruta del SonarScanner desde la configuraci√≥n global
                    def scannerHome = tool 'SonarScanner'  

                    // Ejecutar el an√°lisis SonarQube
                    withSonarQubeEnv('SonarQube') {  
                        sh """
                            ${scannerHome}/bin/sonar-scanner \
                            -Dsonar.projectKey=${SONAR_PROJECT} \
                            -Dsonar.projectName=${SONAR_PROJECT} \
                            -Dsonar.sources=. \
                        """
                    }
                }
            }
        }

        // Enviar el c√≥digo al servidor Docker
        stage('Enviar c√≥digo al servidor Docker') {
            steps {
                withCredentials([sshUserPrivateKey(credentialsId: 'deployuser', 
                                                  keyFileVariable: 'SSH_KEY',
                                                  usernameVariable: 'SSH_USER')]) {

                    sshPut remote: [
                        name: 'docker-server',
                        host: "${DEPLOY_HOST}",
                        user: SSH_USER,
                        identityFile: SSH_KEY,
                        allowAnyHosts: true
                    ],
                    from: '.',
                    into: "${DEPLOY_PATH}"
                }
            }
        }

        // Validar los archivos en el servidor Docker
        stage('Validar archivos en servidor Docker') {
            steps {
                withCredentials([sshUserPrivateKey(credentialsId: 'deployuser', 
                                                  keyFileVariable: 'SSH_KEY',
                                                  usernameVariable: 'SSH_USER')]) {

                    sshCommand remote: [
                        name: 'docker-server',
                        host: "${DEPLOY_HOST}",
                        user: SSH_USER,
                        identityFile: SSH_KEY,
                        allowAnyHosts: true
                    ], command: """
                        echo 'üìÅ Listado de archivos en ${DEPLOY_PATH}/${PROJECT_PATH}/'
                        ls -la ${DEPLOY_PATH}/${PROJECT_PATH}/

                        echo 'üîç Validando archivos requeridos...'

                        test -f ${DEPLOY_PATH}/${PROJECT_PATH}/Dockerfile || { echo '‚ùå Falta Dockerfile'; exit 1; }
                        test -f ${DEPLOY_PATH}/${PROJECT_PATH}/app.csproj || { echo '‚ùå Falta app.csproj'; exit 1; }
                        test -f ${DEPLOY_PATH}/${PROJECT_PATH}/Program.cs || { echo '‚ùå Falta Program.cs'; exit 1; }

                        echo '‚úÖ Todos los archivos est√°n presentes.'
                    """
                }
            }
        }

        // Construir imagen Docker y desplegar contenedor
        stage('Construir y desplegar contenedor') {
            steps {
                withCredentials([sshUserPrivateKey(credentialsId: 'deployuser', 
                                                  keyFileVariable: 'SSH_KEY',
                                                  usernameVariable: 'SSH_USER')]) {

                    sshCommand remote: [
                        name: 'docker-server',
                        host: "${DEPLOY_HOST}",
                        user: SSH_USER,
                        identityFile: SSH_KEY,
                        allowAnyHosts: true
                    ], command: """
                        cd ${DEPLOY_PATH}/${PROJECT_PATH}/

                        echo 'üõë Deteniendo contenedor previo...'
                        docker stop ${CONTAINER_NAME} || true

                        echo 'üóë Eliminando contenedor previo...'
                        docker rm ${CONTAINER_NAME} || true

                        echo 'üì¶ Construyendo imagen en servidor Docker...'
                        docker build -t ${IMAGE_NAME} .

                        echo 'üöÄ Iniciando contenedor...'
                        docker run -d --name ${CONTAINER_NAME} -p 8080:80 ${IMAGE_NAME}
                    """
                }
            }
        }
    }
}
